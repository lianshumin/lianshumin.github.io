---
layout: post
title: OBJC | 版本更新提醒
date: 2017-03-13 16:00:00.000000000 +08:00
comments: true
categories: #objc
---

![](http://omqv71zv3.bkt.clouddn.com/8DDCEAED-EFED-4B15-A928-70F9F534F520.png)

PM要求实现版本更新提醒。其实iOS已有现成的更新机制，但为了和Android版同步，同时避开APPLE审核规定。和PM沟通后，去除带更新功能的CELL，改为APP启动时进行版本更新判断。

实现版本更新判断，图省事可用[iVersion](https://github.com/nicklockwood/iVersion)。
PM要求自定义弹窗UI，于是自己实现了一下 :happy:

原理：

>当前版本号高于AppStore版本号，则弹窗提醒更新。
>
>用户点击更新，通过URL跳转至AppStroe下载。

代码：

```objective-c
- (void)checkVersion{
    
    // 当前版本号
    NSDictionary *infoDic = [[NSBundle mainBundle] infoDictionary];
    NSString *currentVersion = [infoDic objectForKey:@"CFBundleShortVersionString"];
    // 请求
    NSString *url = [NSString stringWithFormat:@"http://itunes.apple.com/CN/lookup?bundleId=%@",APP_BUNDLEID_ID];
    NSMutableURLRequest *urlRequest = [[NSMutableURLRequest alloc] init];
    [urlRequest setURL:[NSURL URLWithString:url]];
    [urlRequest setHTTPMethod:@"POST"];
    // JSON解析
    NSData *returnData = [NSURLConnection sendSynchronousRequest:urlRequest returningResponse:nil error:nil];
    NSDictionary *jsonDic = [NSJSONSerialization JSONObjectWithData:returnData options:kNilOptions error:nil];
    
    NSArray *resultArr = jsonDic[@"results"];
    if (resultArr != nil) {
        NSDictionary *infoDic = resultArr[0];
        NSString *lastVersion = infoDic[@"version"]; //applestore最新版本号
        if (![lastVersion isEqualToString:currentVersion]) {
            // 版本不同，弹出自定义提醒框
            SLAlertUpdateViewController *alertUpdateVc = [[SLAlertUpdateViewController alloc] init];
            alertUpdateVc.lastVersion = lastVersion;
            alertUpdateVc.lastDescription = infoDic[@"releaseNotes"];//applestore版本更新内容
            alertUpdateVc.modalTransitionStyle = UIModalTransitionStyleCrossDissolve;
            alertUpdateVc.providesPresentationContextTransitionStyle = YES;
            alertUpdateVc.definesPresentationContext = YES;
            [alertUpdateVc setModalPresentationStyle:UIModalPresentationOverCurrentContext];
            [[UIApplication sharedApplication].keyWindow.rootViewController presentViewController:alertUpdateVc animated:YES completion:nil];
            
        }else{
            return;
        }
    }
}
```

```
- (IBAction)download {
    
    [self dismissViewControllerAnimated:YES completion:^{
        
        NSURL *url = [NSURL URLWithString:[NSString stringWithFormat:@"https://itunes.apple.com/cn/app/wifi-xiao-guan-jia/id%d",APP_APPLE_ID]];
        [[UIApplication sharedApplication] openURL:url];
    }];
}
```

注意：

>CFBundleVersion：标识内部版本号。
>
>CFBundleShortVersionString：应用的发布版本号。

附：返回的JSON

```json
{
 "resultCount":1,
 "results": [
{"artistViewUrl":"https://itunes.apple.com/cn/developer/shumin-lian/id1173193998?uo=4", "artworkUrl60":"http://is5.mzstatic.com/image/thumb/Purple19/v4/9b/6e/df/9b6edf69-6906-8874-cdf7-ccd1ea9b6e66/source/60x60bb.jpg", "artworkUrl100":"http://is5.mzstatic.com/image/thumb/Purple19/v4/9b/6e/df/9b6edf69-6906-8874-cdf7-ccd1ea9b6e66/source/100x100bb.jpg", 
"ipadScreenshotUrls":["http://a3.mzstatic.com/us/r30/Purple19/v4/09/fb/9c/09fb9c30-b1f0-c113-a70f-0ea187f5bb0f/sc1024x768.jpeg", "http://a3.mzstatic.com/us/r30/Purple71/v4/34/af/8a/34af8aa6-94ff-94b2-2e8a-95474ba55fc2/sc1024x768.jpeg", "http://a1.mzstatic.com/us/r30/Purple71/v4/58/09/03/58090346-bb83-c9c5-aa64-b1c84c3e271f/sc1024x768.jpeg", "http://a3.mzstatic.com/us/r30/Purple71/v4/5c/fa/26/5cfa2622-6b3b-825b-f3b4-9f1ce7d81f30/sc1024x768.jpeg", "http://a1.mzstatic.com/us/r30/Purple71/v4/2c/87/68/2c8768bb-7046-23a2-6227-bec9d1e1b160/sc1024x768.jpeg"], "appletvScreenshotUrls":[], "artworkUrl512":"http://is5.mzstatic.com/image/thumb/Purple19/v4/9b/6e/df/9b6edf69-6906-8874-cdf7-ccd1ea9b6e66/source/512x512bb.jpg", "kind":"software", 
"supportedDevices":["iPad2Wifi-iPad2Wifi", "iPad23G-iPad23G", "iPhone4S-iPhone4S", "iPadThirdGen-iPadThirdGen", "iPadThirdGen4G-iPadThirdGen4G", "iPhone5-iPhone5", "iPodTouchFifthGen-iPodTouchFifthGen", "iPadFourthGen-iPadFourthGen", "iPadFourthGen4G-iPadFourthGen4G", "iPadMini-iPadMini", "iPadMini4G-iPadMini4G", "iPhone5c-iPhone5c", "iPhone5s-iPhone5s", "iPadAir-iPadAir", "iPadAirCellular-iPadAirCellular", "iPadMiniRetina-iPadMiniRetina", "iPadMiniRetinaCellular-iPadMiniRetinaCellular", "iPhone6-iPhone6", "iPhone6Plus-iPhone6Plus", "iPadAir2-iPadAir2", "iPadAir2Cellular-iPadAir2Cellular", "iPadMini3-iPadMini3", "iPadMini3Cellular-iPadMini3Cellular", "iPodTouchSixthGen-iPodTouchSixthGen", "iPhone6s-iPhone6s", "iPhone6sPlus-iPhone6sPlus", "iPadMini4-iPadMini4", "iPadMini4Cellular-iPadMini4Cellular", "iPadPro-iPadPro", "iPadProCellular-iPadProCellular", "iPadPro97-iPadPro97", "iPadPro97Cellular-iPadPro97Cellular", "iPhoneSE-iPhoneSE", "iPhone7-iPhone7", "iPhone7Plus-iPhone7Plus"], "features":["iosUniversal"], 
"screenshotUrls":["http://a2.mzstatic.com/us/r30/Purple19/v4/0a/4f/94/0a4f942d-dfef-b387-2c22-c06422ba6423/screen696x696.jpeg", "http://a2.mzstatic.com/us/r30/Purple71/v4/2b/33/f0/2b33f0c6-fe58-80cc-8edc-8f65fd3e13a8/screen696x696.jpeg", "http://a1.mzstatic.com/us/r30/Purple71/v4/75/7a/07/757a074c-75a6-d619-d6ba-1b4d6f743c72/screen696x696.jpeg", "http://a2.mzstatic.com/us/r30/Purple71/v4/ee/31/06/ee310639-8eb9-b9fe-950c-e3a2d1e03d20/screen696x696.jpeg", "http://a3.mzstatic.com/us/r30/Purple71/v4/f5/da/da/f5dadac6-b41b-6208-d758-d131c33b0b70/screen696x696.jpeg"], "advisories":[], "isGameCenterEnabled":false, "trackCensoredName":"晴子日语 - 自学日语的非凡搭档", 
"trackViewUrl":"https://itunes.apple.com/cn/app/%E6%99%B4%E5%AD%90%E6%97%A5%E8%AF%AD-%E8%87%AA%E5%AD%A6%E6%97%A5%E8%AF%AD%E7%9A%84%E9%9D%9E%E5%87%A1%E6%90%AD%E6%A1%A3/id1173193999?mt=8&uo=4", "contentAdvisoryRating":"4+", "averageUserRatingForCurrentVersion":4.5, "languageCodesISO2A":["ZH"], "fileSizeBytes":"64332800", "sellerUrl":"http://imlian.com", "userRatingCountForCurrentVersion":5, "trackContentRating":"4+", "currency":"CNY", "wrapperType":"software", "version":"1.01", "artistId":1173193998, "artistName":"SHUMIN LIAN", "genres":["教育"], "price":0.00, "description":"晴子日语-自学日语的非凡搭档\n\n写 | 五十音图\n学 | 简明日语\n听 | 日本电台\n见 | 新闻直播\n译 | 中日口译", "trackId":1173193999, "trackName":"晴子日语 - 自学日语的非凡搭档", "bundleId":"com.imlian.QZJapanese", "releaseNotes":"1.优化了语音识别界面\n2.优化了启动页界面\n3.修复了iOS10 以下启动闪退bug\n4.修复了主页重复刷新bug", "primaryGenreName":"Education", "isVppDeviceBasedLicensingEnabled":true, "releaseDate":"2016-11-18T23:01:11Z", "primaryGenreId":6017, "formattedPrice":"免费", "sellerName":"SHUMIN LIAN", "genreIds":["6017"], "currentVersionReleaseDate":"2016-11-20T21:03:47Z", "minimumOsVersion":"8.0", "averageUserRating":4.5, "userRatingCount":7}]
}
```

