---
layout: post
title: OBJC | AFN封装小记
date: 2017-08-11 16:00:00.000000000 +08:00
comments: true
categories: #objc
---

![](http://omqv71zv3.bkt.clouddn.com/AFN%E5%B0%81%E8%A3%85%E5%B0%8F%E8%AE%B001)

项目开发间隙，觉得之前封装的AFN用起来不是太顺手，重新封装了一下。

1.服务器返回数据框架

```objective-c
{
  "message" : "OK",
  "result" : [],
  "httpCode" : 200
}
```

2.类说明

```
ZZNetworkManager:基于AFHTTPSessionManager的封装
ZZNetworkingResponse:解析服务器返回数据，作一些公共配置
```

3.ZZNetworkManager

```objective-c
#import "ZZNetworkingResponse.h"

@interface ZZNetworkManager : AFHTTPSessionManager

+ (nullable instancetype)shareManager;

NS_ASSUME_NONNULL_BEGIN

#pragma mark - API

+ (void)GET:(NSString *)URLString
 parameters:(id)parameters
   response:(void (^)(NSURLSessionDataTask * task,id responseObject,NSError * error))response;

+ (void)POST:(NSString *)URLString
  parameters:(id)parameters
    response:(void (^)(NSURLSessionDataTask * task,id responseObject,NSError * error))response;

+ (void)POST:(NSString *)URLString
  parameters:(id)parameters
constructingBodyWithBlock:(void (^)(id <AFMultipartFormData> formData))block
    response:(void (^)(NSURLSessionDataTask * task,id responseObject,NSError *error))response;

+ (void)PUT:(NSString *)URLString
 parameters:(id)parameters
   response:(void (^)(NSURLSessionDataTask * task,id responseObject,NSError *error))response;

+ (void)DELETE:(NSString *)URLString
    parameters:(id)parameters
      response:(void (^)(NSURLSessionDataTask * task,id responseObject,NSError *error))response;

#pragma mark - NEW API

/**
 GET请求
 
 @param url 请求地址
 @param params 请求参数
 @param successblock 请求成功
 @param failureblock 请求失败
 */
+ (void)getRequest:(NSString *)url
            params:(NSDictionary *)params
           success:(void (^)(id data))successblock
           failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock;

/**
 POST请求
 
 @param url 请求地址
 @param params 请求参数
 @param successblock 请求成功
 @param failureblock 请求失败
 */
+ (void)postRequest:(NSString *)url
             params:(NSDictionary *)params
            success:(void (^)(id data))successblock
            failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock;

/**
 POST请求
 
 @param url 请求地址
 @param params 请求参数
 @param block 上传大文件
 @param successblock 请求成功
 @param failureblock 请求失败
 */
+ (void)postRequest:(NSString *)url
             params:(NSDictionary *)params
constructingBodyWithBlock:(void (^)(id <AFMultipartFormData> formData))block
            success:(void (^)(id data))successblock
            failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock;

/**
 delete请求
 
 @param url 请求地址
 @param params 请求参数
 @param successblock 请求成功
 @param failureblock 请求失败
 */
+ (void)deleteRequest:(NSString *)url
               params:(NSDictionary *)params
              success:(void (^)(id data))successblock
              failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock;

NS_ASSUME_NONNULL_END
@end
```

```objective-c
@implementation ZZNetworkManager

#pragma mark - Setup

+ (instancetype)shareManager
{
    static ZZNetworkManager *manager = nil;
    
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        manager = [ZZNetworkManager manager];
        
        /**
            请求超时时间
        */
        manager.requestSerializer.timeoutInterval = 30;
        
        /**
            请求的数据类型
            AFHTTPRequestSerializer HTTP二进制(默认)
            AFJSONRequestSerializer JSON(POST JSON) RESTful 设计风格需要
            AFPropertyListRequestSerializer PList(POST Plist－开发中几乎不用)
         */
        manager.requestSerializer = [AFHTTPRequestSerializer serializer];
        
        /*
            请求头类型
            [manager.requestSerializer setValue:@"application/json" forHTTPHeaderField:@"Accept"];
            [manager.requestSerializer setValue:@"application/json; charset=utf-8" forHTTPHeaderField:@"Content-Type"];
         */
        
        /**
            返回的数据类型
            AFHTTPResponseSerializer HTTP二进制
            AFJSONResponseSerializer JSON(默认)
            AFXMLParserResponseSerializer XML Parser解析器 SAX解析
            AFXMLDocumentResponseSerializer (Mac OS X) XML DOM
            AFPropertyListResponseSerializer PList几乎不用
            AFImageResponseSerializer 图像，不支持GIF
            AFCompoundResponseSerializer 组合的
        */
        manager.responseSerializer = [AFJSONResponseSerializer serializer];
        manager.responseSerializer.acceptableContentTypes = [NSSet setWithObjects:@"application/json", @"text/html", @"text/json", @"text/javascript", @"application/x-javascript", @"text/plain", @"image/gif", nil];
        
        /**
            HTTPS
         */
        manager.securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeNone];
        [manager.securityPolicy setAllowInvalidCertificates:NO];//不允许无效的证书
    });
    
    [manager setupHTTPHeader];
    
    return manager;
}

- (void)setupHTTPHeader
{
    NSString *token = [UserData userInfo].token;
    [self.requestSerializer setValue:token forHTTPHeaderField:@"token"];//token = @"610c0236-ba96-48e8-a196-69293bf63f8f";
    DebugLog(@"| HTTP HEAD | %@", [self.requestSerializer HTTPRequestHeaders]);
}

#pragma mark - API

+ (void)GET:(NSString *)URLString
 parameters:(id)parameters
   response:(void (^)(NSURLSessionDataTask * task,
                      id responseObject,
                      NSError *error))response
{
    DebugLog(@"| GET       |\n| URL       | %@\n| PARAM     | \n%@", URLString, parameters);
    
    ZZNetworkManager *manager = [ZZNetworkManager shareManager];
    [manager GET:URLString
      parameters:parameters
        progress:nil
         success:^(NSURLSessionDataTask * task, id responseObject)
             {
                if (response)
                {
                    response(task, responseObject, nil);
                }
             }
         failure:^(NSURLSessionDataTask * task, NSError * error)
             {
                if (response)
                {
                    response(task, nil, error);
                }
             }];
}

+ (void)POST:(NSString *)URLString
  parameters:(id)parameters
    response:(void (^)(NSURLSessionDataTask * task,
                      id responseObject,
                      NSError *error))response
{
    
    DebugLog(@"| POST      |\n| URL       | %@\n| PARAM     | \n%@", URLString, parameters);
    
    ZZNetworkManager *manager = [ZZNetworkManager shareManager];
    [manager POST:URLString
       parameters:parameters
         progress:nil
          success:^(NSURLSessionDataTask * task, id responseObject)
            {
                if (response)
                {
                response(task, responseObject, nil);
                }
            }
          failure:^(NSURLSessionDataTask * task, NSError * error)
            {
                if (response)
                {
                    response(task, nil, error);
                }
            }];
    
}

+ (void)POST:(NSString *)URLString
  parameters:(id)parameters
constructingBodyWithBlock:(void (^)(id <AFMultipartFormData> formData))block
    response:(void (^)(NSURLSessionDataTask * task,
                       id responseObject,
                       NSError *error))response
{
    
    DebugLog(@"| POST DATA |\n| URL       | %@\n| PARAM     | \n%@", URLString, parameters);
    
    ZZNetworkManager *manager = [ZZNetworkManager shareManager];
    [manager POST:URLString
       parameters:parameters
constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData)
            {
                if (block)
                {
                    block(formData);
                }
            }
         progress:^(NSProgress * _Nonnull uploadProgress)
            {}
          success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject)
            {
                if (response)
                {
                    response(task, responseObject, nil);
                }
            }
          failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error)
            {
                if (response)
                {
                    response(task, nil, error);
                }
            }];
}

+ (void)PUT:(NSString *)URLString
 parameters:(id)parameters
   response:(void (^)(NSURLSessionDataTask * task,
                       id responseObject,
                       NSError *error))response
{
    DebugLog(@"| PUT       |\n| URL       | %@\n| PARAM     | \n%@", URLString, parameters);
    
    ZZNetworkManager *manager = [ZZNetworkManager shareManager];
    [manager PUT:URLString
      parameters:parameters
         success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject)
            {
                 if (response)
                 {
                     response(task, responseObject, nil);
                 }
            }
         failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error)
            {
                 if (response)
                 {
                     response(task, nil, error);
                 }
            }];
}


+ (void)DELETE:(NSString *)URLString
    parameters:(id)parameters
      response:(void (^)(NSURLSessionDataTask * task,
                      id responseObject,
                      NSError *error))response
{
    DebugLog(@"| DELE      |\n| URL       | %@\n| PARAM     | \n%@", URLString, parameters);
    
    ZZNetworkManager *manager = [ZZNetworkManager shareManager];
    [manager DELETE:URLString
         parameters:parameters
            success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject)
                {
                     if (response) {
                         response(task, responseObject, nil);
                     }
                }
            failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error)
                {
                     if (response) {
                         response(task, nil, error);
                     }
                }];
}

#pragma mark - NEW API

+ (void)getRequest:(NSString *)url
            params:(NSDictionary *)params
           success:(void (^)(id data))successblock
           failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock{
    
    [ZZNetworkManager GET:url
               parameters:params
                 response:^(NSURLSessionDataTask * _Nonnull task, id  _Nonnull responseObject, NSError * _Nonnull error) {
                     
                     ZZNetworkingResponse *resp = [ZZNetworkingResponse responseWithTask:task
                                                                                response:responseObject
                                                                                   error:error];
                     if (resp.errorCode == ERROR_CODE_SUCCESS) {
                         if (successblock) {
                             successblock(resp.data);
                         }
                     }else{
                         if (failureblock) {
                             failureblock(resp.errorMessage,resp.errorCode);
                         }
                     }
                 }];
}

+ (void)postRequest:(NSString *)url
             params:(NSDictionary *)params
            success:(void (^)(id data))successblock
            failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock{
    
    [ZZNetworkManager POST:url
                parameters:params
                  response:^(NSURLSessionDataTask * _Nonnull task, id  _Nonnull responseObject, NSError * _Nonnull error) {
                      
                      ZZNetworkingResponse *resp = [ZZNetworkingResponse responseWithTask:task
                                                                                 response:responseObject
                                                                                    error:error];
                      if (resp.errorCode == ERROR_CODE_SUCCESS) {
                          if (successblock) {
                              successblock(resp.data);
                          }
                      }else{
                          if (failureblock) {
                              failureblock(resp.errorMessage,resp.errorCode);
                          }
                      }
                  }];
}

+ (void)postRequest:(NSString *)url
             params:(NSDictionary *)params
constructingBodyWithBlock:(void (^)(id <AFMultipartFormData> formData))block
            success:(void (^)(id data))successblock
            failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock{
    
    [ZZNetworkManager POST:url parameters:params constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
        
        if (block) {
            block(formData);
        }
    } response:^(NSURLSessionDataTask * _Nonnull task, id  _Nonnull responseObject, NSError * _Nonnull error) {
        
        ZZNetworkingResponse *resp = [ZZNetworkingResponse responseWithTask:task
                                                                   response:responseObject
                                                                      error:error];
        if (resp.errorCode == ERROR_CODE_SUCCESS) {
            if (successblock) {
                successblock(resp.data);
            }
        }else{
            if (failureblock) {
                failureblock(resp.errorMessage,resp.errorCode);
            }
        }
    }];
}

+ (void)deleteRequest:(NSString *)url
               params:(NSDictionary *)params
              success:(void (^)(id data))successblock
              failure:(void (^)(NSString *errorMessage,NSInteger errorCode))failureblock{
    
    [ZZNetworkManager DELETE:url
                  parameters:params
                    response:^(NSURLSessionDataTask * _Nonnull task, id  _Nonnull responseObject, NSError * _Nonnull error) {
                        
                        ZZNetworkingResponse *resp = [ZZNetworkingResponse responseWithTask:task
                                                                                   response:responseObject
                                                                                      error:error];
                        
                        if (resp.errorCode == ERROR_CODE_SUCCESS) {
                            if (successblock) {
                                successblock(resp.data);
                            }
                        }else{
                            if (failureblock) {
                                failureblock(resp.errorMessage,resp.errorCode);
                            }
                        }
                    }];
}
```

4.ZZNetworkingResponse

```objective-c
@interface ZZNetworkingResponse : NSObject
@property (assign, nonatomic) NSInteger errorCode;
@property (strong, nonatomic) NSString *errorMessage;
@property (strong, nonatomic) id data;

+ (instancetype)responseWithTask:(NSURLSessionDataTask *)task
                        response:(id)responseObject
                           error:(NSError *)error;
+ (instancetype)responseWithJson:(id)jsonString;
- (void)toastErrorMessage;
@end
```

```objective-c
#import "NetStatusMgr.h"//网络状态
#import "SLLogWindow.h" //调试窗口

@implementation ZZNetworkingResponse

#pragma mark - API

+ (instancetype)responseWithTask:(NSURLSessionDataTask *)task
                        response:(id)responseObject
                           error:(NSError *)error
{
    ZZNetworkingResponse *response = [[ZZNetworkingResponse alloc] initWithTask:task response:responseObject error:error];
    return response;
}

+ (instancetype)responseWithJson:(id)jsonString
{
    ZZNetworkingResponse *response = [[ZZNetworkingResponse alloc] initWithJsonString:jsonString];
    return response;
}

#pragma mark - Setup

- (id)init
{
    if (self = [super init]) {
        _errorCode = ERROR_CODE_FAILD;
        _errorMessage = nil;
        _data = nil;
    }
    return self;
}

- (instancetype)initWithTask:(NSURLSessionDataTask *)task
                    response:(id)responseObject
                       error:(NSError *)error
{
    if (self = [self init]) {
        
        if ([((NSHTTPURLResponse *)task.response) statusCode] != ERROR_CODE_SUCCESS) {
            // 失败
            if (![NetStatusMgr sharedNetStatusMgr].isNetworkReachable  || error.code == -1009) {
                _errorMessage = @"无法访问网络,请检查网络设置!";
            }
            else if (error.code == -1003 || error.code == -1004) {
                _errorMessage = @"服务器开小差,请稍后再试~";
            }
            else if (error.code == -1001) {
                _errorMessage = @"请求超时,请稍后再试~";
            }
            else {
                _errorMessage = [error localizedDescription];
                _errorMessage = @"服务器开小差,请稍后再试~";
            }
            
            NSString *str = [NSString stringWithFormat:@"\n| FAILD     | \n| URL       | %@\n| JSON      | %@\n| RESPONSE  | \n%@\n| ERROR     | \n%@", [task.originalRequest URL], [responseObject jsonPrettyStringEncoded], _errorMessage, error];
            NSLog(@"%@",str);
            [SLLogWindow printLog:str];
            
            return self;
        }
        
        [self parseWithJson:responseObject];
        
        if (_errorCode == ERROR_CODE_SUCCESS) {
            // 服务器返回成功
            NSString *str = [NSString stringWithFormat:@"\n| SUCCESS   | \n| URL       | %@\n| RESPONSE  | \n%@", [task.originalRequest URL], [responseObject jsonPrettyStringEncoded]];
            NSLog(@"%@",str);
            [SLLogWindow printLog:str];
        }else {
            // 服务器返回失败
            NSString *str = [NSString stringWithFormat:@"\n| FAILD     | \n| URL       | %@\n| JSON      | %@\n| RESPONSE  | \n%@\n| ERROR     | \n%@", [task.originalRequest URL], [responseObject jsonPrettyStringEncoded], _errorMessage, error];
            NSLog(@"%@",str);
            [SLLogWindow printLog:str];
            
            if (_errorCode == 409) {
                // Token失效
                [UserData doLogout];
                [UIView toast:@"token失效,请重新登录!"];
            }
        }
        
    }
    return self;
}

- (instancetype)initWithJsonString:(NSString *)jsonString
{
    if (self = [self init]) {
        NSLog(@"\n| JSON      | \n%@", jsonString);
        [self parseWithJson:jsonString];
    }
    
    return self;
}

- (instancetype)parseWithJson:(id)json
{
    if (json) {
        
        id root = nil;
        if ([json isKindOfClass:[NSString class]]) {
            NSData *jsonData = [json dataUsingEncoding:NSUTF8StringEncoding];
            //解析json数据，使用系统方法 JSONObjectWithData:  options: error:
            root = [NSJSONSerialization JSONObjectWithData:jsonData options:NSJSONReadingMutableLeaves error:nil];
        }else {
            root = json;
        }
        
        if (root) {
            NSString *errorCode = nil;
            if ([root isKindOfClass:[NSDictionary class]]) {
                errorCode = [root objectForKey:@"httpCode"];
                _errorMessage = [root objectForKey:@"message"];
                _data = [root objectForKey:@"result"];
                if (!errorCode && !_errorMessage && !_data) {
                    _data = root;
                }
            }
            _errorCode = errorCode ? [errorCode intValue] : ERROR_CODE_SUCCESS;
        }
        else {
            NSLog(@"\n| FAILD     | \n%@", json);
            _errorCode = ERROR_CODE_FAILD;
        }
    }
    return self;
}

#pragma mark - showNewbieDialog
- (void)showBlackListDialog {
/*
    if (s_blackListMsgView) {
        return;
    }
    
    NSString *message = @"您的账号已被禁用，请联系客服了解详情。（QQ2749792995）";
    
    if (!IS_NULL_STRING(_errorMessage)) {
        message = _errorMessage;
    }
    
    LYMessageView *msg = [LYMessageView messageViewWithTitle:@"提示"
                                                     message:message
                                                 buttonBlock:^(NSInteger btnType) {
                                                     
                                                     if (btnType == EMessageButtonTypeOK) {
                                                         if (![AppHelper isInLoginView]) {
                                                             //                                                             [[AppHelper appDelegate] enterLogin];
                                                             //                                                             [UserData doLogout];
                                                             s_blackListMsgView = nil;
                                                         }
                                                     }
                                                     
                                                 }];
    
    [msg.messageLabel setText:message];
    [msg hideCancelButton];
    [msg showInView:[AppHelper activeWindow]];
*/
}


- (BOOL)isShouldShowErrorMessage
{
    if (_errorCode != ERROR_CODE_SUCCESS &&
        _errorCode != ERROR_CODE_BLACK_LIST) {
        return YES;
    }
    
    return NO;
}

- (void)toastErrorMessage
{
    if (![self isShouldShowErrorMessage]) {
        [UIView hideHUD];
        return;
    }
    
    NSString *error = self.errorMessage;
    if (IS_NULL_STRING(error)) {
        error = _(@"NET_TIP_NET_ERROR");
    }
    
    [UIView toast:error];

}

@end
```